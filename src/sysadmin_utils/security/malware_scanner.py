import hashlib
import os
from pathlib import Path
from typing import List, Optional

# Example list of known malicious hashes (SHA-256)
# In a real scenario, this should be loaded from a database or external file.
MALICIOUS_HASHES = {
    'a5b69f8e2f9cfaa239deca4ad927f8e4f4d38e4dc153d69f2902af438f61bca7',
    'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855', # Empty file hash
}

def calculate_sha256(file_path: Path) -> str:
    """Calculates the SHA-256 hash of a file."""
    sha256_hash = hashlib.sha256()
    with open(file_path, "rb") as f:
        # Read in chunks to avoid memory issues with large files
        for byte_block in iter(lambda: f.read(4096), b""):
            sha256_hash.update(byte_block)
    return sha256_hash.hexdigest()

def scan_file(file_path: Path) -> bool:
    """
    Scans a single file against known malicious hashes.
    
    Args:
        file_path (Path): Path to the file to scan.
        
    Returns:
        bool: True if the file is infected, False otherwise.
    """
    try:
        file_hash = calculate_sha256(file_path)
        if file_hash in MALICIOUS_HASHES:
            print(f"[!] WARNING: {file_path} is INFECTED! (Hash: {file_hash})")
            return True
        else:
            print(f"[+] {file_path} is clean.")
            return False
    except Exception as e:
        print(f"[!] Error scanning {file_path}: {e}")
        return False

def scan_directory(directory: Path) -> List[Path]:
    """
    Recursively scans a directory for infected files.
    
    Args:
        directory (Path): Directory to scan.
        
    Returns:
        List[Path]: List of infected files found.
    """
    infected_files = []
    directory = Path(directory)
    
    if not directory.exists():
        print(f"[!] Directory not found: {directory}")
        return []

    print(f"[*] Starting scan of {directory}...")
    
    for path in directory.rglob("*"):
        if path.is_file():
            if scan_file(path):
                infected_files.append(path)
                
    return infected_files

if __name__ == "__main__":
    import sys
    
    # Simple CLI argument parsing
    target_dir = sys.argv[1] if len(sys.argv) > 1 else "."
    scan_directory(Path(target_dir))
